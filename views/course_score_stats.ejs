<div class="content">
    <div class="container mt-5">
        <h2>Course Scores Details of Students</h2>
        <table class=" table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Batch</th>
                    <th>DSA</th>
                    <th>Web Dev</th>
                    <th>React</th>
                </tr>
            </thead>
            <tbody>
                <% studentsStats.forEach((stats)=>{ %>
                <tr data-stats='<%= JSON.stringify(stats) %>'>
                    <td contenteditable="false"><%= stats.student.name %></td>
                    <td contenteditable="false"><%= stats.student.email %></td>
                    <td contenteditable="false"><%= stats.student.batch.year %> - <%= stats.student.batch.month %></td>
                    <td contenteditable="false"><%= stats.dsa %></td>
                    <td contenteditable="false"><%= stats.webD %></td>
                    <td contenteditable="false"><%= stats.react %></td>    
                    <td>
                        <button class="btn btn-warning btn-sm edit-btn" onclick="editRowStats(this)">Edit</button>
                        <button class="btn btn-danger btn-sm delete-btn" onclick="deleteRowStats(this)" data-stats-id="<%= stats._id %>">Delete</button>
                        <button class="btn btn-success btn-sm update-btn" onclick="updateRowStats(this)" style="display:none;" data-stats-id="<%= stats._id %>">Update</button>
                        <button class="btn btn-secondary btn-sm cancel-btn" onclick="cancelEditStats(this)" style="display:none;">Cancel</button>
                    </td>          
                </tr>
                <%})%>
            </tbody>
        </table>
    </div>
</div>

<script>
function editRowStats(button) {
    // Get the parent row
    const row = button.closest('tr');
    
    // Find the cells containing the data to be edited
    const dsaCell = row.querySelector('td:nth-child(4)');
    const webDCell = row.querySelector('td:nth-child(5)');
    const reactCell = row.querySelector('td:nth-child(6)');
    
    // Get the current data
    const dsaData = dsaCell.innerText;
    const webDData = webDCell.innerText;
    const reactData = reactCell.innerText;
    
    // Replace the data with input fields
    dsaCell.innerHTML = `<input type="number" value="${dsaData}">`;
    webDCell.innerHTML = `<input type="number" value="${webDData}">`;
    reactCell.innerHTML = `<input type="number" value="${reactData}">`;
    
    // Hide edit button and show update and cancel buttons
    button.style.display = 'none';
    row.querySelector('.delete-btn').style.display = 'none';
    row.querySelector('.update-btn').style.display = 'inline-block';
    row.querySelector('.cancel-btn').style.display = 'inline-block';
}

function cancelEditStats(button) {
    // Get the parent row
    const row = button.closest('tr');
    
    // Restore the previous state
    const stats = JSON.parse(row.getAttribute('data-stats'));
    row.querySelector('td:nth-child(4)').innerHTML = stats.dsa;
    row.querySelector('td:nth-child(5)').innerHTML = stats.webD;
    row.querySelector('td:nth-child(6)').innerHTML = stats.react;
    
    // Show edit button and hide update and cancel buttons
    row.querySelector('.edit-btn').style.display = 'inline-block';
    row.querySelector('.delete-btn').style.display = 'inline-block';
    row.querySelector('.update-btn').style.display = 'none';
    row.querySelector('.cancel-btn').style.display = 'none';
}

function updateRowStats(button) {
    // Get the parent row
    const row = button.closest('tr');
    // Retrieve the stats id from the data attribute
    const statsData = JSON.parse(row.getAttribute('data-stats'));
    //Get the data from input fields & Prepare the updated data
    const updatedStats = {
        dsa: row.querySelector('td:nth-child(4) input').value,
        webD: row.querySelector('td:nth-child(5) input').value,
        react: row.querySelector('td:nth-child(6) input').value
    };
    // Send an asynchronous request to update the student's information
    fetch(`/course-scores/update/${statsData._id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedStats)
    })
    .then(response => response.json())
    .then(data => {
        // on success update data in row in table
        if (data.success) {
            row.querySelector('td:nth-child(4)').innerText = data.stats.dsa;
            row.querySelector('td:nth-child(5)').innerText = data.stats.webD;
            row.querySelector('td:nth-child(6)').innerText = data.stats.react;     
            // Show edit button and hide update and cancel buttons
            row.querySelector('.edit-btn').style.display = 'inline-block';
            row.querySelector('.delete-btn').style.display = 'inline-block';
            row.querySelector('.update-btn').style.display = 'none';
            row.querySelector('.cancel-btn').style.display = 'none';
        } else {
            // Handle the case where the update was not successful
            alert('Update failed. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error updating course scores data:', error);
    });
}

function deleteRowStats(button) {
    // Confirmation box
    if (confirm('Are you sure you want to delete this row?')) {
        // Get the parent row
        const row = button.closest('tr');
        const statsId = button.getAttribute('data-stats-id');
        fetch(`/course-scores/delete/${statsId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Delete response from server:', data);

            // If the deletion was successful, remove the row from the table
            const row = button.closest('tr');
            row.remove();
        })
        .catch(error => {
            console.error('Error during delete request:', error);
            // Handle errors as needed
        });
    }
} 
</script>